name: Publish reBabel
on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  increment-reBabel-version:
    runs-on: ubuntu-latest
    outputs: 
      output1: ${{steps.step4.outputs.reBabel_version}}
    steps:
      - uses: actions/checkout@master
        with:
          ref: main
      - uses: actions/setup-node@master
        with:
          node-version: "18"
      - name: Setup Git Credentials
        uses: fregante/setup-git-user@v2
      - id: step4
        run: |
          echo "reBabel_version=$(npm version prerelease --preid=alpha)" >> "$GITHUB_OUTPUT"
          git status
          ls
          git push && git push --tags && rm -rf build/temp
  build-reBabel-on-Linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@master
        with:
          ref: main
      - uses: actions/setup-node@master
        with:
          node-version: "18"
      - name: Install Node dependencies for reBabel
        run: npm install
      - name: Create rebabel_convert executable
        shell: bash
        run: .github/scripts/create_rebabel_convert_executable
      - name: Produce reBabel executable reBabel to GitHub releases
        run: npm run make
      - name: List files
        run: ls /home/runner/work/gha_test/gha_test/out/make/deb/x64
      - name: Upload reBabel Linux
        uses: actions/upload-artifact@v4
        with:
          name: reBabel_linux_amd64.deb
          path: /home/runner/work/gha_test/gha_test/out/make/deb/x64/rebabel*.deb
  build-reBabel-on-Windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@master
        with:
          ref: main
      - uses: actions/setup-node@master
        with:
          node-version: "18"
      - name: Install Node dependencies for reBabel
        run: npm install
      - name: Create rebabel_convert executable
        shell: pwsh
        run: .github/scripts/create_rebabel_convert_executable_windows.ps1
      - name: Create reBabel executable
        run: npm run make
      - name: List files
        run: ls ./out/make/squirrel.windows/x64
      - name: Upload reBabel Windows
        uses: actions/upload-artifact@v4
        with:
          name: reBabel_windows
          path: D:\a\gha_test\gha_test\out\make\squirrel.windows\x64\rebabel*Setup.exe
  create-reBabel-release:
    needs: [build-reBabel-on-Linux, build-reBabel-on-Windows, increment-reBabel-version]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@master
        with:
          ref: main
      - uses: actions/setup-node@master
        with:
          node-version: "18"
      - name: Download Linux artifact
        uses: actions/download-artifact@v4
        with:
          name: reBabel_linux_amd64.deb
      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: reBabel_windows
      - name: List files
        run: ls
      - name: Rename files
        run: mv ./rebabel*.deb ./rebabel_linux.deb
      - name: Rename more files
        run: mv ./*.exe ./rebabel_windows.Setup.exe
      - name: List files
        run: ls
      - name: Create release
        env:
          VERSION: ${{needs.increment-reBabel-version.outputs.output1}}
        run: |
          echo $VERSION
          gh release create $VERSION -pt  "reBabel Release" --notes "" ./rebabel_windows.Setup.exe ./rebabel_linux.deb
